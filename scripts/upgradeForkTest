# #!/bin/bash

set -eo pipefail

# cat, grep for env var, cut at delimiter '=', choose 2nd
MATIC_ARCHIVE_URL=$(cat .env | grep MATIC_ARCHIVE_URL | cut -d'=' -f 2)
MAINNET_FORK_PORT=8545

### Functions
evm_running() {
  nc -z localhost "$MAINNET_FORK_PORT"
}
evm_start() {
  echo "Starting our own evm instance at port $MAINNET_FORK_PORT"
  npx hardhat node --fork "$MATIC_ARCHIVE_URL" > /dev/null &
}

evm_kill() {
  if evm_running; then
    echo "Killing evm instance at port $MAINNET_FORK_PORT"
    kill -9 $(lsof -i:$MAINNET_FORK_PORT -t)
  fi
}

### Main
evm_kill
evm_start # ensure the matic-fork is up and running before the test starts
yarn run build
npx hardhat test upgrades/upgradeFork.test.ts --network matic-fork

### Cleanup
# Exit error mode so the evm instance always gets killed
set +e
evm_kill
exit



